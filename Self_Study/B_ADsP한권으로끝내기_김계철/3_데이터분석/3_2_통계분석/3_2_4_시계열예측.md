# 3.2.4. 시계열 예측

## 1) 시계열

- 시계열이란?
    - 시간의 흐름에 따라서 관측된 데이터를 시계열 자료라고함
    - 주파수 영역 정보와 시간 영역 정보를 가짐
        - 주파수영역(frequency domain)
            - 주기적으로 반복되는 정보
            - 어떤 주기의 변동이 존재하는지 여부 확인
            - 주기도(periodogram) : 시계열이 어떤 주기들을 갖고 움직이는지를 나타내 주는 도표
            - 주기도에서 특정 주파수에 큰 값이 나타나면 시계열에 해당 주파수(또는 주기)의 변동이 큰 것을 알 수 있음
            - 주기도는 너무 변동성이 커서 평활화 → 스펙트럴밀도함수(스펙트럼)
        - 시간영역(time domain) : 시간에 따라 전개되는 정보
    - 구성 성분
        - 추세요인(trend factor) : 장기간에 걸친 상승이나 하강의 경향
        - 계절성 요인(seasonal factor) : 특정 기간 동안의 주기적 변동성
        - 순환요인(cyclical factor) : 계절성 이외의 요인으로 인한 추세 이탈
        - 불규칙한요인(irregular factor) : 추세, 계절, 주기 이외의 남은 움직임, 잡음이나 오차
    - 종류
        - 연속(continuos) 시계열
            - 자료가 연속적으로 생성
            - 실제로 많은 시계열들이 연속적으로 생성됨
        - 이산(discrete) 시계열
            - 이산적 시점에서 자료가 생성
            - 일정한 시차를 두고 관측되므로 이산시계열의 형태를 지니는 경우가 많음
        - 정적 시계열
            - 평균이나 분산이 일정한 모습을 보이는 데이터
            - 구간을 달리하더라도 매 구간별로 그 특성이 동일함
        - 비정적 시계열
            - 평균이나 분산이 일정하지 않은 모습을 보이는 데이터
            - 분석하기 어려운 시계열 자료로 대부분의 시계열 자료
    
- 시계열 분석
    - 시간의 흐름에 따라 데이터가 따르는 패턴을 찾는 방법
    - 패턴을 확인하기 위해 그래프를 그려서 패턴 존재유무를 먼저 확인
    - 시계열 분석을 위해서는 정상성(stationary)를 만족해야함
    - 회귀분석과의 차이 : 시간을 고려

---

## 2) 정상성

- 정상성이란?
    - 시계열의 수준과 분산에 체계적인 변화가 없고, 엄밀하게 주시적 변동이 없다는 것으로, 미래는 확률적으로 과거와 동일하다는 것을 뜻함
    - 조건
        - 평균값은 시간에 관계없이 일정
        - 분산값은 시간에 관계없이 일정
        - 공분산은 시간에 의존하지 않고 오직 시차에만 의존
    - 시계열 자료 예시
        
        ```r
        Nile
        plot(Nile) # 비계절성을 띠는 데이터 확인 가능, 정상성 만족하지 않음
        Nile.diff1 = diff(Nile, differences=1)
        plot(Nile.diff1)# 1차 차분 결과 역시 평균이 일정하지 않음
        Nile.diff2 = diff(Nile, differences = 2)
        plot(Nile.diff2)# 2차 차분한 결과 어느정도 정상성을 만족
        ```
        
        ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled.png)
        
        ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%201.png)
        
        ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%202.png)
        

---

## 3) 비정상시계열을 정상시계열로 전환하는 방법

- 시계열의 평균이 일정하지 않은 경우에는 원 시계열에 차분(현재 싲머에서 바로 전 시점의 자료 값을 빼는 것)하면 정상 시계열이 됨
- 계절성을 갖는 비정상시계열은 정상 시계열로 바꿀 때 계절 차분을 사용
- 분산이 일정하지 않은 경우에는 원 시계열에 자연로그를 취하면 정상 시계열이 됨

---

## 4) 시계열 분석 방법

- 시계열 요소 분해법
    - 시계열 자료의 4가지 변동요인을 찾아서 시각적으로 분석하는 기법
    - 대체로 추세와 계절 변동요인은 추세선에서 뚜렷하게 나타남
    - 특히 추세 변동 분석은 시계열 자료가 증감하는 경향이 있는지를 파악하고, 증감 경향의 선형여부를 찾는 과정이 필요
        - 차분 후 일정한 값을 나타내면 선형의 패턴
        - 로그변환 후 일정한 값을 나타내면 비선형의 패턴(U자)
        - 고르변환 후 1차 차분 결과가 일정한 값으로 나타나면 성장곡선의 패턴(S자)

- 평활법(smoothing method)
    - 시계열 자료의 체계적인 자료의 흐름을 파악하기 위해서 과거 자료의 불규칙적인 변동을 제거하는 방법
    - 시계열 자료의 뾰족한 작은 변동들을 제거하여 부드러운 곡선으로 시계열 자료를 조정하는 기법
    - 대표적인 평활법
        - 이동평균(MA, moving average)
            - 시계열 자료를 대상으로 일정한 기간의 자료를 평균으로 계산하고 이동시킨 추세를 파악하여 다음 기간의 추세를 예측하는 방법
            - 시계열 자료에서 계절변동과 불규칙변동을 제거하여 추세변동과 순환변동만 갖는 시계열로 변환
            - 자료의 수가 많고 비교적 안정적인 패턴을 보이는경우 효과적
        - 지수평활법(exponential smoothing)
            - 전체 시계열 자료를 이용하여 평균을 구하고, 최근 시계열에 더 큰 가중치를 적용하는 방법
    
- ARIMA 모형법
    - 시계열 모형은 정상성의 조건 유무에 따라 두가지로 분류
        - 정상성을 가진 시계열 모형 : 자기회귀모형(AR), 이동평균모형(MA). 자기회귀이동평균모형(ARMA)
        - 비정상성을 가진 시계열 모형 : 자기회귀누적이동평균모형(ARIMA)
    - ARIMA 모형으로 시계열 자료를 처리하는 절차는 모형의 식별, 추정 그리고 진단의 과정을 거침
        - 식별
            - ARIMA의 3개 차수(p,d,q)를 결정하는 단계
            - 현재 시계열 자료가 어떤 모형(AR, MA, ARMA)에 해당하는 가를 판단하는 단계
            - 식별 수단은 자기상관함수 또는 부분자기상관함수를 이용
        - 추정
            - 식별된 모형의 파라미터를 추정하는 단계
            - 최소제곱법을 이용
        - 진단
            - 모형이 적합한지를 검증하는 단계
            - 검증의 수단으로 잔차가 백색잡음(white noise)인지를 살펴보고, 백색 잡음과 차이가 없다면 적합하다고 할 수 있음
            - 백색잡음이란 모형의 잔차가 불규칙적이고 독립적으로 분포된 경우를 의미, 즉, 특정 시차 간의 데이터가 서로 관련이 없다는 것을 의미

---

## 5) 시계열모형

- 백색잡음과정
    - 시계열이 과거와 아무런 상관이 없음
    - 백색잡음은 상호 독립적이고 같은 분포를 갖는 확률변수로 구성
    - ACF와 PACF는 0

- 자기회귀(AR, autoregressive) 모형
    - $Z_t=\Phi_1Z_{t-1}+\Phi_2Z_{t-2}+....+\Phi_pZ_{t-p}+a_t$
        - $Z_t$ : 현재 시점의 시계열 자료
        - $Z_{t-1},Z_{t-2}...$ : 1~p 시점 이전의 시계열 자료
        - $\Phi_p$ : p시점이 현재 시점에 어느정도 영향을 주는지 나타내는 모수
        - $a_t$ : 백색잡음과정(대표적 정상 시계열), 시계열분석에서 오차항을 의미
    - 자기 자신의 과거 값을 사용하기 때문에 이름이 붙여짐
    - 어떤 변수에 대해서 이전 값이 이후의 값에 영향을 미치는 경우에 적용
    - 현 시점의 자료가 p시점 전의 유한개의 과거 자료로 설명될 수 있다는 의미이며 AR(p)모형이라 함
    - 1차 AR 모형, 즉 AR(1)모형은 백색잡음의 현재 값과 1스텝 과거의 자기 자신의 값만 가중합으로 이루어진 모형
    - 자기회귀모형의 목표는 현 시점의 시계열 자료에 몇 번째 전 자료까지 영향을 주는지 알아내는데 있음
    - 자기회귀모형인지 판단하기 위해 데이터에 자기상관함수(ACF)와 부분자기상관함수(PACF)를 이용
        - 일반적으로 자기회귀모형은 ACF가 시차가 증가함에 따라 점차적으로 감소
        - PACF는 p+1시차 이후 급격히 감소하여 절단된 형태를 취함
        
- 이동평균모형(MA, moving average)
    - $Z_t=a_t-\theta_1a_{t-1}-\theta_2a_{t-2}-....-\theta_pa_{t-p}$
    - 시간이 지나면서 어떤 변수의 평균값이 지속적으로 감소하거나 증가하는 경향이 있는 경우에 적용
    - 현 시점의 자료를 유한개의 백색잡음의 선형결합으로 표현하기 때문에 항상 정상성을 만족
    - 따라서 MA는 정상성 가정이 불필요
    - 1차 이동평균모형, MA(1)모형은 가장 간단한 이동평균모형으로 같은 시점의 백색잡음과 바로 전 시점의 백색잡음의 결합으로 이루어진 모형
    - MA는 AR과 반대로 ACF는 p+1시차 이후 절단된 형태이며 PACF는 점차 감소하는 형태

- ARMA
    - AR+MA
    - 시계열이 과거의 실제값과 과거에 발생했던 충격으로 동시에 설명되는 모형
    
- ARIMA(autoregressive integrated moving average) 모형
    - 기본적으로 비정상시계열 모형이기 때문에 차분이나 변환을 통해 AR, MA, ARMA 모형으로 정상화 가능
    - 차수 p,d,q의 값에 따라 모형의 이름이 다르게 됨
    - 차수 p는 AR과 관련, q는 MA와 관련이 있는 차수이며 d는 ARIMA에서 ARMA로 정상화할 때 몇번 차분을 했는지 의미
    - ARMA 모형이 과거의 데이터를 사용하는 것에 비해 ARIMA 모형은 과거의 데이터가 가지는 추세(momentum)도 반영
    - 현 시점의 관측값이 과거의 관측값들 및 오차들과 선형결합된 모형

- 모형결정 및 예측 예시
    
    ```r
    > acf(Nile.diff2,lag.max=20,plot=FALSE)
    
    Autocorrelations of series ‘Nile.diff2’, by lag
    
         0      1      2      3      4      5      6      7 
     1.000 -0.626  0.100  0.067 -0.072  0.017  0.074 -0.192 
         8      9     10     11     12     13     14     15 
     0.245 -0.079 -0.153  0.183 -0.106  0.062  0.010 -0.096 
        16     17     18     19     20 
     0.134 -0.134  0.091 -0.030  0.003
     
    > acf(Nile.diff2,lag.max=20)
    ```
    
    ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%203.png)
    
    - lag가 1과 8인 경우를 제외하고 모두 신뢰구간에 존재
    
    ```r
    > pacf(Nile.diff2,lag.max=20, plot=FALSE)
    
    Partial autocorrelations of series ‘Nile.diff2’, by lag
    
         1      2      3      4      5      6      7      8 
    -0.626 -0.481 -0.302 -0.265 -0.273 -0.112 -0.353 -0.213 
         9     10     11     12     13     14     15     16 
     0.038 -0.120 -0.117 -0.197 -0.132 -0.055 -0.109  0.022 
        17     18     19     20 
    -0.184 -0.067 -0.037 -0.024 
    
    > pacf(Nile.diff2,lag.max=20)
    ```
    
    ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%204.png)
    
    - lag=8까지 신뢰구간을 넘고 lag=9에서 절단
    
    ```r
    > install.packages('forecast')
    > library(forecast)
    > auto.arima(Nile)
    Series: Nile 
    ARIMA(1,1,1) 
    
    Coefficients:
             ar1      ma1
          0.2544  -0.8741
    s.e.  0.1194   0.0605
    
    sigma^2 = 20177:  log likelihood = -630.63
    AIC=1267.25   AICc=1267.51   BIC=1275.04
    ```
    
    - auto.arima()함수를 이용해 ARIMA(1,1,1) 모형 결정
    
    ```r
    > Nile.arima = arima(Nile, order=c(1,1,1))
    > Nile.arima
    
    Call:
    arima(x = Nile, order = c(1, 1, 1))
    
    Coefficients:
             ar1      ma1
          0.2544  -0.8741
    s.e.  0.1194   0.0605
    
    sigma^2 estimated as 19769:  log likelihood = -630.63,  aic = 1267.25
    > Nile.forecast = forecast(Nile.arima,h=50)
    > Nile.forecast
         Point Forecast    Lo 80     Hi 80    Lo 95    Hi 95
    1971       816.1813 635.9909  996.3717 540.6039 1091.759
    1972       835.5596 642.7830 1028.3363 540.7332 1130.386
    1973       840.4889 643.5842 1037.3936 539.3492 1141.629
    # (이하생략)
    
    > plot(Nile.forecast)
    ```
    
    ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%205.png)
    
    - 데이터에 모형을 적합한 수 forecast함수를 이용해 50개 연도 데이터 예측

---

## 6) 분해시계열

- 분해시계열이란?
    - 시계열에 영향을 주는 일반적인 요인을 시계열에서 분리해 분석하는 방법
    - 각 구성요인을 정확하게 분리하는 것이 중요
    - 분해식의 일반적 정의
        - $Z_t= f(T_t(추세요인),S_t(계절요인),C_t(순환요인),I_t(불규칙요인))$
        - 추세요인
            - 데이터를 그래프로 그릴때, 그 형태가 오르거나 내리는 추세를 따르는 경우가 있음
            - 선형적인 추세 외에도 이차식이나 지수적 형태를 취할수 있음
            - 이렇게 자료가 어떤 특정한 형태를 취할 때 추세 요인이라 함
        - 계절요인
            - 계절에 따라 고정된 주기에 따라 자료가 변화할 경우 계절 요인이라함
        - 순환요인
            - 명백한 경제적이나 자연적인 이유가 없이 알려지지 않은 주기를 가지고 자료가 변화할 때 순환요인이라 함
        - 불규칙요인
            - 위 세 가지 요인으로 설명할 수 없는 회귀분석에서 오차에 해당하는 요인
    - 계절요인을 가지는 데이터 확인
        
        ```r
        > plot(ldeaths)
        ```
        
        ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%206.png)
        
    - decompose()를 이용한 4가지 요인으로 분해
        
        ```r
        > ldeaths.decompose = decompose(ldeaths)
        > ldeaths.decompose$seasonal
                   Jan       Feb       Mar       Apr       May
        1974  873.7514  896.3347  687.5431  156.5847 -284.4819
        1975  873.7514  896.3347  687.5431  156.5847 -284.4819
        1976  873.7514  896.3347  687.5431  156.5847 -284.4819
        # 이하 생략
        
        plot(ldeaths.decompose)
        ```
        
        ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%207.png)
        
    - 계절성을 띠는 시계열 자료는 계절요인을 추정해 그 값을 원 시계열 자료에서 빼면 조정 가능
        
        ```r
        > ldeaths.decompose.adj = ldeaths-ldeaths.decompose$seasonal
        > plot(ldeaths.decompose.adj)
        ```
        
        ![Untitled](3%202%204%20%E1%84%89%E1%85%B5%E1%84%80%E1%85%A8%E1%84%8B%E1%85%A7%E1%86%AF%20%E1%84%8B%E1%85%A8%E1%84%8E%E1%85%B3%E1%86%A8%2002afa3c0f9a449adacf465ec34d1ccad/Untitled%208.png)